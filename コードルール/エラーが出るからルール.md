# 開発ルールとよくあるエラーの原因

このプロジェクトで開発を進める上でのルールや、エラーを未然に防ぐための注意点をまとめます。新しい機能を追加・修正する際は、必ずこの内容を確認してください。

## 1. エフェメラル（一時的な）メッセージの送信

インタラクションへの返信を「あなたにだけ表示されています」という一時的なメッセージにする場合、`ephemeral: true` ではなく `flags` プロパティを使用します。特に `deferReply` と組み合わせる際は必須です。

**良い例:**
```javascript
const { MessageFlags } = require('discord.js');

// 先にエフェメラルで応答を保留
await interaction.deferReply({ flags: MessageFlags.Ephemeral });
// その後、編集
await interaction.editReply({ content: '処理が完了しました。' });

// または、直接返信する場合
await interaction.reply({
  content: 'これは一時的なメッセージです。',
  flags: MessageFlags.Ephemeral,
});
```

**悪い例:**
```javascript
// 古い、または非推奨の方法
await interaction.reply({ content: '...', ephemeral: true });
```

---

## 2. Custom IDの管理

ボタン、モーダル、セレクトメニューなどの `customId` は、文字列リテラルで直接書くのではなく、**必ず定数として定義**してください。これにより、タイポによるバグを防ぎ、コードの保守性が向上します。

**良い例 (`keihiHandler.js`):**
```javascript
// ファイルの先頭でIDを定数として定義
const BUTTON_ID = 'keihi_shinsei_button';
const MODAL_ID = 'keihi_shinsei_modal';

module.exports = {
  async execute(interaction) {
    if (interaction.isButton() && interaction.customId === BUTTON_ID) {
      // ...
    }
    if (interaction.isModalSubmit() && interaction.customId === MODAL_ID) {
      // ...
    }
  }
  // ...
}
```

**悪い例:**
```javascript
// customIdが文字列でハードコーディングされている
if (interaction.customId === 'keihi_shinsei_button') {
  // ...
}
```

---

## 3. 非同期処理と `await`

Discord.jsのほとんどの操作（メッセージの送信、ロールの付与、APIへの問い合わせなど）は非同期処理（Promiseを返す）です。これらの処理を呼び出す際は、**必ず `await` を付けてください**。`await` を忘れると、処理の完了を待たずに次のコードが実行されてしまい、予期せぬエラーや動作不良の原因となります。

**良い例:**
```javascript
await interaction.reply({ content: 'メッセージを送信します。' });
const member = await interaction.guild.members.fetch(interaction.user.id);
await member.roles.add('ROLE_ID');
```

**悪い例:**
```javascript
// awaitを忘れている
interaction.reply({ content: 'このメッセージは送信されない可能性があります。' });
```

---

## 4. 3秒以上かかる処理と `deferReply`

コマンドやボタンの処理に3秒以上かかる可能性がある場合（例: 外部APIへのアクセス、GCSからのファイル読み込み）、Discordからの応答がタイムアウトしてしまいます。
これを防ぐため、処理の最初に **`interaction.deferReply()`** を呼び出してください。これにより、応答が保留され、Botは最大15分間処理を続けることができます。

```javascript
async execute(interaction) {
  // まず応答を保留する
  await interaction.deferReply();

  // 時間のかかる処理...
  const result = await someLongRunningTask();

  // 処理が終わったら、応答を編集する
  await interaction.editReply({ content: `結果: ${result}` });
}
```

---

## 5. エラーハンドリング

各コマンドやハンドラーの `execute` 関数内では、`try...catch` ブロックを使用してエラーを適切に捕捉してください。
エラーが発生した場合は、`logger.error` を使って詳細な情報を記録し、ユーザーには簡潔なエラーメッセージを返します。

```javascript
async execute(interaction) {
  try {
    // メインの処理
    await someFunctionThatMightFail(interaction);
  } catch (error) {
    logger.error('〇〇の処理中にエラーが発生しました。', {
      error,
      guildId: interaction.guild?.id,
      userId: interaction.user.id,
    });
    const reply = { content: 'コマンドの実行中にエラーが発生しました。', flags: MessageFlags.Ephemeral };
    // 既に返信済みかチェックして、followUpまたはreplyを使い分ける
    await (interaction.replied || interaction.deferred ? interaction.followUp(reply) : interaction.reply(reply));
  }
}
```

---

## 6. 設定値の管理

チャンネルIDやAPIキーなどの設定値は、コード内に直接書き込まず、`.env` ファイルで管理します。
新しい環境変数を追加した場合は、必ず `.env.sample` にもその変数を追記し、他の開発者が設定内容を把握できるようにしてください。

**`.env` の例:**
```
DISCORD_TOKEN=your_token_here
KEIHI_LOG_CHANNEL_ID=123456789012345678
```

**`.env.sample` の例:**
```
DISCORD_TOKEN=
KEIHI_LOG_CHANNEL_ID=
```

---

## 7. モジュール構造

新しい機能は、`keihi_bot` や `leveling_bot` のように、機能ごとのディレクトリ（モジュール）として作成します。
各モジュールの `index.js` は、その機能が提供する `commands` と `componentHandlers` をエクスポートする必要があります。

**`leveling_bot/index.js` の例:**
```javascript
const rankCommand = require('./commands/rank.js');
const levelSettingsHandler = require('./handlers/levelSettingsHandler.js');

module.exports = {
  commands: [rankCommand],
  componentHandlers: [levelSettingsHandler],
};
```