# SVML事務Bot 処理フロー

このドキュメントは、Botの起動からユーザーの操作に応答するまでの一連の処理の流れを説明します。
アーキテクチャは、機能ごとに独立した**モジュール形式**を採用しています。

## 1. 起動プロセス (Startup Process)

Botがオンラインになるまでの初期化シーケンスです。

1.  **エントリーポイント実行 (`index.js`)**
    *   Botのメインファイル `index.js` が起動します。

2.  **機能モジュールの読み込み (`index.js`)**
    *   `index.js` は `keihi_bot`, `leveling_bot` のような機能別ディレクトリをスキャンします。
    *   各ディレクトリの `index.js` (例: `keihi_bot/index.js`) を `require` し、そこから `commands` と `componentHandlers` を受け取ります。
    *   すべての `commands` は `client.commands` に登録されます。
    *   すべての `componentHandlers` は `client.componentHandlers` という単一の配列に集約・登録されます。

3.  **イベントリスナー登録 & ログイン (`index.js`)**
    *   `events` ディレクトリをスキャンし、`interactionCreate.js` などのイベントリスナーを `client` に登録します。
    *   `client.login()` が呼び出され、BotがDiscordに接続します。

---

## 2. インタラクション処理プロセス (Interaction Handling Process)

1.  **中央ハブによる受信 (`events/interactionCreate.js`)**
    *   ユーザーがコマンドやボタンを操作すると、Discordから `interactionCreate` イベントが送信されます。
    *   起動時に登録された `client.on('interactionCreate', ...)` が発火し、`events/interactionCreate.js` の `execute` 関数が呼び出されます。このファイルがすべてのインタラクションの入り口（ルーター）となります。

2.  **処理の分岐 (ルーティング)**
    *   **A) スラッシュコマンドの場合:** `interaction.isChatInputCommand()` でコマンドかどうかを判定し、`client.commands` から該当コマンドを実行します。
    *   **B) ボタンやモーダルの場合:** 起動時に `client.componentHandlers` に集約された全機能のハンドラーを一つずつループ処理します。

3.  **個別ハンドラーによる実行 (`*_bot/handlers/*.js`)**
    *   ループの中で、各ハンドラー（例: `keihiHandler.js`, `levelSettingsHandler.js`）の `execute(interaction)` 関数が呼び出されます。
    *   ハンドラーは `interaction.customId` を見て、自身が処理すべき操作かを判断します。
    *   **処理対象の場合:** モーダル表示や設定保存などの固有処理を実行し、`true` を返します。
    *   **処理対象でない場合:** 何もせず `false` を返します。

4.  **処理の完了**
    *   `events/interactionCreate.js` のループは、いずれかのハンドラーが `true` を返した時点で終了します。これにより、一つのインタラクションが複数のハンドラーによって重複して処理されるのを防ぎます。